<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | CloudRetail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --admin-dark: #212529; --sl-maroon: #800000; }
        body { background: #f8f9fa; }
        .sidebar { height: 100vh; background: var(--admin-dark); color: white; position: fixed; width: 250px; padding: 20px; }
        .main-content { margin-left: 260px; padding: 30px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .product-list-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .table thead { background-color: #f1f1f1; }
    </style>
</head>
<body>

<div class="sidebar shadow">
    <h3 class="fw-bold mb-4 text-warning">CloudRetail Admin</h3>
    <hr>
    <nav class="nav flex-column">
        <a class="nav-link text-white" href="#productSection"><i class="bi bi-box-seam me-2"></i>Manage Products</a>
        <a class="nav-link text-white" href="#orderSection"><i class="bi bi-cart-check me-2"></i>Manage Orders</a>
        <a class="nav-link text-white" href="index.html"><i class="bi bi-shop me-2"></i>View Storefront</a>
        <hr>
        <button class="btn btn-outline-danger btn-sm mt-3" onclick="localStorage.clear(); window.location.href='login.html'">Logout</button>
    </nav>
</div>

<div class="main-content">
    <div class="container-fluid">
        <h2 class="mb-4">Admin Dashboard</h2>
        
        <div class="card p-4 mb-5" id="productSection">
            <h5 class="card-title mb-4 fw-bold text-primary" id="formTitle"><i class="bi bi-plus-circle me-2"></i>Add New Product</h5>
            <form id="adminProductForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="pName" class="form-control" placeholder="e.g. Men's Kurta" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Category</label>
                        <select id="pCat" class="form-select">
                            <option value="Silk">Silk</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Menswear">Menswear</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Price (LKR)</label>
                        <input type="number" id="pPrice" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Old Price</label>
                        <input type="number" id="pBefore" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Discount %</label>
                        <input type="text" id="pDisc" class="form-control" placeholder="10%">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" id="pStock" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Product Image (File Explorer)</label>
                        <input type="file" id="pImgFile" class="form-control" accept="image/*">
                        <input type="hidden" id="pExistingImg">
                    </div>
                </div>
                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-success px-5 fw-bold">Sync with Database</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear / Reset</button>
                </div>
            </form>
        </div>

        <div class="card p-4 mb-5 shadow-sm">
            <h5 class="mb-4 fw-bold"><i class="bi bi-list-ul me-2"></i>Current Inventory</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr><th>Image</th><th>Name</th><th>Price</th><th>Stock</th><th>Action</th></tr>
                    </thead>
                    <tbody id="inventoryList"></tbody>
                </table>
            </div>
        </div>

        <div class="card p-4 shadow-sm" id="orderSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0"><i class="bi bi-receipt me-2"></i>Customer Orders History</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()"><i class="bi bi-arrow-clockwise me-1"></i>Refresh Data</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr><th>Order ID</th><th>Customer Email</th><th>Total (LKR)</th><th>Status</th></tr>
                    </thead>
                    <tbody id="adminOrderList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    if(localStorage.getItem('userRole') !== 'admin') {
        alert("Unauthorized Access!");
        window.location.href = "index.html";
    }

    let allProducts = [];

    // --- PRODUCT MANAGEMENT ---

    function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    document.getElementById('adminProductForm').onsubmit = async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('pImgFile');
        let finalImageUrl = document.getElementById('pExistingImg').value;

        if (fileInput.files.length > 0) {
            finalImageUrl = await convertToBase64(fileInput.files[0]);
        }
        
        const productData = {
            name: document.getElementById('pName').value,
            category: document.getElementById('pCat').value,
            price_lkr: parseInt(document.getElementById('pPrice').value),
            before_price: parseInt(document.getElementById('pBefore').value) || 0,
            discount: document.getElementById('pDisc').value || "0%",
            stock_quantity: parseInt(document.getElementById('pStock').value),
            image_url: finalImageUrl || "https://via.placeholder.com/200",
            status: parseInt(document.getElementById('pStock').value) > 0 ? "In Stock" : "Out of Stock"
        };

        try {
            const res = await fetch('https://cloudretail-products.onrender.com', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(productData)
            });
            const result = await res.json();
            alert(result.message);
            resetForm();
            loadInventory();
        } catch (err) {
            alert("Error: Check if Products Service (5001) is running.");
        }
    };

    async function loadInventory() {
        try {
            const res = await fetch('https://cloudretail-products.onrender.com/products');
            allProducts = await res.json();
            const list = document.getElementById('inventoryList');
            
            list.innerHTML = allProducts.map((p, index) => `
                <tr>
                    <td><img src="${p.image_url}" class="product-list-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td class="fw-bold">${p.name}</td>
                    <td>LKR ${p.price_lkr.toLocaleString()}</td>
                    <td><span class="badge ${p.stock_quantity > 5 ? 'bg-light text-dark' : 'bg-danger'}">${p.stock_quantity}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm btn-edit-admin" data-index="${index}">Edit</button>
                        <button class="btn btn-danger btn-sm btn-del-admin" data-index="${index}">Delete</button>
                    </td>
                </tr>`).join('');

            attachAdminListeners();
        } catch (err) { console.error("Inventory error"); }
    }

    // FIX: Professional Event Listeners that handle quotes in names
    function attachAdminListeners() {
        document.querySelectorAll('.btn-edit-admin').forEach(btn => {
            btn.onclick = function() {
                const idx = this.getAttribute('data-index');
                const p = allProducts[idx];
                document.getElementById('formTitle').innerHTML = `<i class="bi bi-pencil-square me-2"></i>Update Product: ${p.name}`;
                document.getElementById('pName').value = p.name;
                document.getElementById('pCat').value = p.category;
                document.getElementById('pPrice').value = p.price_lkr;
                document.getElementById('pBefore').value = p.before_price;
                document.getElementById('pDisc').value = p.discount;
                document.getElementById('pStock').value = p.stock_quantity;
                document.getElementById('pExistingImg').value = p.image_url;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
        });

        document.querySelectorAll('.btn-del-admin').forEach(btn => {
            btn.onclick = async function() {
                const idx = this.getAttribute('data-index');
                const p = allProducts[idx];
                if(confirm("Confirm deletion of: " + p.name + "?")) {
                    const res = await fetch(`https://cloudretail-products.onrender.com/delete-product/${encodeURIComponent(p.name)}`, { method: 'DELETE' });
                    const result = await res.json();
                    alert(result.message);
                    loadInventory();
                }
            };
        });
    }

    function resetForm() {
        document.getElementById('adminProductForm').reset();
        document.getElementById('formTitle').innerHTML = `<i class="bi bi-plus-circle me-2"></i>Add New Product`;
        document.getElementById('pExistingImg').value = "";
    }

    // --- ORDER MANAGEMENT ---

    async function loadOrders() {
        const list = document.getElementById('adminOrderList');
        try {
            const res = await fetch('https://cloudretail-orders.onrender.com/history');
            const orders = await res.json();
            
            if (!orders || orders.length === 0) {
                list.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No real-time sales found in database.</td></tr>';
                return;
            }

            // Reverse to show newest orders first
            orders.reverse();

            list.innerHTML = orders.map(o => `
                <tr>
                    <td><strong class="text-primary">#${o.order_id || 'N/A'}</strong></td>
                    <td>${o.customer_email || 'Guest'}</td>
                    <td class="fw-bold">LKR ${(o.total_amount_lkr || 0).toLocaleString()}</td>
                    <td><span class="badge ${o.order_status === 'Processing' ? 'bg-warning text-dark' : 'bg-success'}">${o.order_status || 'Pending'}</span></td>
                </tr>`).join('');
        } catch (err) {
            list.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">Error: Order Service (5003) is unreachable.</td></tr>';
        }
    }

    window.onload = () => { loadInventory(); loadOrders(); };
</script>
</body>
</html>