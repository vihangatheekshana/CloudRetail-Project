<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Orders | CloudRetail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --maroon: #800000; }
        .navbar { background: var(--maroon); }
        .order-card { 
            border: none; 
            border-radius: 15px; 
            transition: 0.3s; 
            border-left: 5px solid var(--maroon);
        }
        .order-card:hover { transform: scale(1.01); box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important; }
        .status-badge { font-size: 0.8rem; padding: 5px 12px; border-radius: 50px; }
        .text-maroon { color: var(--maroon); }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark px-4 shadow-sm">
    <a class="navbar-brand fw-bold" href="index.html">
        <i class="bi bi-arrow-left"></i> Back to Shop
    </a>
</nav>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold m-0">Order History</h2>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>

            <div id="orderContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-maroon" role="status"></div>
                    <p class="mt-2 text-muted">Fetching your history...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadOrders() {
        const userEmail = localStorage.getItem('userEmail');
        const container = document.getElementById('orderContainer');

        if (!userEmail) {
            window.location.href = "login.html";
            return;
        }

        try {
            // Fetching from the Orders Service history route
            const res = await fetch('https://cloudretail-orders.onrender.com/history');
            const allOrders = await res.json();
            
            // Filter orders to only show those belonging to the logged-in user
            const myOrders = allOrders.filter(o => o.email === userEmail || o.customer_email === userEmail);

            if (myOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 bg-white rounded-4 shadow-sm">
                        <i class="bi bi-bag-x text-muted" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">No orders found</h4>
                        <p class="text-muted">Start shopping to see your orders here.</p>
                        <a href="index.html" class="btn btn-danger mt-2" style="background:#800000;">Shop Now</a>
                    </div>`;
                return;
            }

            // Sort by most recent first
            myOrders.reverse();

            container.innerHTML = myOrders.map(o => `
                <div class="card order-card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted small text-uppercase mb-1">Order Reference</h6>
                                <h5 class="fw-bold text-maroon">#${o.order_id || 'N/A'}</h5>
                            </div>
                            <span class="badge status-badge ${o.status === 'Delivered' ? 'bg-success' : 'bg-warning text-dark'}">
                                ${o.status || 'Processing'}
                            </span>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-7">
                                <h6 class="fw-bold small border-bottom pb-2">Purchased Items</h6>
                                <ul class="list-unstyled mb-0">
                                    ${(o.items || []).map(item => `
                                        <li class="d-flex justify-content-between py-1">
                                            <span>${item.name}</span>
                                            <span class="text-muted">LKR ${item.price.toLocaleString()}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="col-md-5 text-md-end mt-3 mt-md-0">
                                <h6 class="text-muted small">Total Amount Paid</h6>
                                <h3 class="text-danger fw-bold">LKR ${(o.total_price || o.total_amount_lkr || 0).toLocaleString()}</h3>
                                <p class="small text-muted mb-0"><i class="bi bi-calendar-event"></i> ${o.date || 'Today'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            container.innerHTML = `
                <div class="alert alert-danger text-center shadow-sm">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Connection Error: Could not reach Order Service on Port 5003.
                </div>`;
        }
    }

    // Load orders as soon as the page opens
    window.onload = loadOrders;
</script>

</body>
</html>