<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shop | CloudRetail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --maroon: #800000; --gold: #FFD700; }
        body { background-color: #f8f9fa; }
        .navbar { background: var(--maroon); }
        .product-img-container { height: 200px; overflow: hidden; background: #fff; display: flex; align-items: center; justify-content: center; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card { border: none; border-radius: 12px; transition: 0.3s; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
        .discount-badge { position: absolute; top: 10px; right: 10px; background: var(--gold); color: black; padding: 2px 10px; font-weight: bold; border-radius: 5px; z-index: 5; }
        .cart-sidebar { position: fixed; right: 0; top: 0; width: 350px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 20px; display: none; z-index: 2000; flex-direction: column; }
        .cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .filter-btn { border-radius: 20px; margin-right: 5px; transition: 0.2s; }
        .filter-btn.active { background-color: var(--maroon) !important; color: white !important; border-color: var(--maroon) !important; }
    </style>
</head>
<body>

<div id="cartOverlay" class="cart-overlay" onclick="toggleCart()"></div>

<nav class="navbar navbar-expand-lg navbar-dark px-4 sticky-top shadow-sm">
    <a class="navbar-brand fw-bold" href="landing.html">CLOUDRETAIL</a>
    <div class="ms-auto d-flex align-items-center">
        <span class="text-white me-3" id="userDisplay"></span>
        <a href="orders.html" class="btn btn-sm btn-warning me-2 fw-bold">My Orders</a>
        <button class="btn btn-outline-light btn-sm" onclick="toggleCart()">
            <i class="bi bi-cart3"></i> Cart (<span id="cartCount">0</span>)
        </button>
        <button class="btn btn-link text-white text-decoration-none ms-3" onclick="logout()">Logout</button>
    </div>
</nav>

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Our Collection</h2>
        <div id="categoryFilters">
            <button class="btn btn-outline-secondary btn-sm filter-btn active" onclick="filterProducts('All', this)">All</button>
            <button class="btn btn-outline-secondary btn-sm filter-btn" onclick="filterProducts('Silk', this)">Silk</button>
            <button class="btn btn-outline-secondary btn-sm filter-btn" onclick="filterProducts('Jewelry', this)">Jewelry</button>
            <button class="btn btn-outline-secondary btn-sm filter-btn" onclick="filterProducts('Menswear', this)">Menswear</button>
        </div>
    </div>
    <div id="productList" class="row g-4"></div>
</div>

<div id="cartSidebar" class="cart-sidebar shadow">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">Your Bag</h4>
        <button class="btn-close" onclick="toggleCart()"></button>
    </div>
    <hr>
    <div id="cartItems" class="flex-grow-1" style="overflow-y: auto;"></div>
    <div class="mt-auto pt-3 border-top">
        <h5>Total: <span class="text-danger fw-bold">LKR <span id="cartTotal">0</span></span></h5>
        <button class="btn btn-success w-100 mt-3 py-2 fw-bold" onclick="goToCheckout()">Proceed to Checkout</button>
    </div>
</div>

<script>
    if(localStorage.getItem('isLoggedIn') !== 'true') window.location.href = "login.html";
    document.getElementById('userDisplay').innerText = "Hello, " + localStorage.getItem('userName');

    let cart = [];
    let allProducts = [];

    async function loadProducts() {
        try {
            const res = await fetch('http://127.0.0.1:5001/products');
            allProducts = await res.json();
            displayProducts(allProducts);
        } catch (error) {
            console.error("API Error:", error);
            document.getElementById('productList').innerHTML = '<p class="text-center mt-5">Error: Products Service not running.</p>';
        }
    }

    function displayProducts(products) {
        const container = document.getElementById('productList');
        if(!products || products.length === 0) {
            container.innerHTML = '<p class="text-center text-muted my-5">No products found.</p>';
            return;
        }
        
        container.innerHTML = products.map((p, index) => `
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm border-0 position-relative">
                    ${p.discount && p.discount !== '0%' ? `<div class="discount-badge">-${p.discount}</div>` : ''}
                    <div class="product-img-container">
                        <img src="${p.image_url}" class="product-img" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h6 class="fw-bold mb-1">${p.name}</h6>
                        <p class="small text-muted mb-2">Stock: ${p.stock_quantity}</p>
                        <div class="mt-auto">
                            <h5 class="text-danger fw-bold m-0">LKR ${p.price_lkr.toLocaleString()}</h5>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-warning btn-sm flex-grow-1 fw-bold btn-buy-now" 
                                    data-index="${index}" ${p.stock_quantity <= 0 ? 'disabled' : ''}>Buy Now</button>
                                <button class="btn btn-outline-dark btn-sm btn-add-cart" 
                                    data-index="${index}" ${p.stock_quantity <= 0 ? 'disabled' : ''}>
                                    <i class="bi bi-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`).join('');

        // Attach listeners manually so product names never break the HTML
        attachActionListeners(products);
    }

    function attachActionListeners(currentDisplayedProducts) {
        document.querySelectorAll('.btn-buy-now').forEach(btn => {
            btn.onclick = () => {
                const p = currentDisplayedProducts[btn.getAttribute('data-index')];
                buyNow(p.name, p.price_lkr);
            };
        });
        document.querySelectorAll('.btn-add-cart').forEach(btn => {
            btn.onclick = () => {
                const p = currentDisplayedProducts[btn.getAttribute('data-index')];
                addToCart(p.name, p.price_lkr);
            };
        });
    }

    function filterProducts(category, btnElement) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        const filtered = category === 'All' ? allProducts : allProducts.filter(p => p.category === category);
        displayProducts(filtered);
    }

    function toggleCart() {
        const sidebar = document.getElementById('cartSidebar');
        const overlay = document.getElementById('cartOverlay');
        const isVisible = sidebar.style.display === 'flex';
        sidebar.style.display = isVisible ? 'none' : 'flex';
        overlay.style.display = isVisible ? 'none' : 'block';
    }

    function addToCart(name, price) {
        cart.push({name, price});
        updateCartUI();
        toggleCart(); 
    }

    function buyNow(name, price) {
        localStorage.setItem('currentCart', JSON.stringify([{name, price}]));
        window.location.href = "checkout.html";
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    function updateCartUI() {
        document.getElementById('cartCount').innerText = cart.length;
        const total = cart.reduce((sum, item) => sum + item.price, 0);
        document.getElementById('cartTotal').innerText = total.toLocaleString();
        
        const cartItemsContainer = document.getElementById('cartItems');
        cartItemsContainer.innerHTML = cart.length === 0 ? '<p class="text-center text-muted my-5">Empty bag</p>' : 
            cart.map((item, index) => `
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded shadow-sm">
                <div class="small"><span class="d-block fw-bold">${item.name}</span>LKR ${item.price.toLocaleString()}</div>
                <button class="btn btn-sm text-danger" onclick="removeFromCart(${index})"><i class="bi bi-trash"></i></button>
            </div>`).join('');
    }

    function goToCheckout() {
        if(cart.length === 0) return alert("Your bag is empty!");
        localStorage.setItem('currentCart', JSON.stringify(cart));
        window.location.href = "checkout.html";
    }

    function logout() { localStorage.clear(); window.location.href = "landing.html"; }
    window.onload = loadProducts;
</script>
</body>
</html>